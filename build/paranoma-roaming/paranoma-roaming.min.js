!function(t,e,o){function i(t){this.navbar=t.navbar||[],this.container=t.container,this.longitude_range=t.longitude_range||[],this.latitude_range=t.latitude_range||[],this.left=0,this.right=0,this.up=0,this.down=0,this.forward=0,this.back=0,this.leftTo=0,this.rightTo=0,this.upTo=0,this.downTo=0,this.state="pause",this.stateType={play:"play",pause:"pause"},this.longitude=0,this.longitudeOffset=0,this.longitudeDatum=.02,this.latitude=0,this.latitudeOffset=0,this.latitudeDatum=.02,this.moveToLocation={longitude:null,latitude:null},this.frameNumber=0,this.frameDatum=1,this.frameNumberOffset=0,this.ready=!1,this.pictures={list:t.pictures,count:t.pictures.length,index:0,lastPicture:""},this.cache_texture=0,this.cache={count:50,current:0,next:100,first:!0,finish:!1,texture:[]},this.viewer,this.baseUrl=t.baseUrl,this.loadingVideo=t.loadingVideo,this.loadingVideoLoop=t.loadingVideoLoop||!1,this.videoContainer,this.video,this.image,this.loadingImage=t.loadingImage,this.relativeUrl,this.preloadWindow,this.lastAudio=null,this.audio,this.bgAudio,this.bgAudioUrl=t.bgAudio||null,this.bgAudioVolume=t.bgAudioVolume||.5,this.lastSubTitles=[],this.preloadWorker,this.init()}i.prototype.init=function(){var t=this;this.initRelativeUrl(),this.initLoadingVideo(),this.initAudio(),this.showLoading(),this.initPreloadPanoramas().then(function(){return t.preloadPanoramasInIframe()}).then(function(){return t.preloadPanoramasInTexture(0,t.cache_texture/2)}).then(function(){t.render(),t.ready=!0,t.closeLoading()}),this.initNavbar(),this.initViewer()},i.prototype.initRelativeUrl=function(){for(var t=this.baseUrl,e="",o=t.split("/").length-1,i=0;i<o;i++)e+="../";this.relativeUrl=e},i.prototype.initLoadingVideo=function(){var t,o,i,n=this.baseUrl+"video.html",a=this.relativeUrl+this.loadingVideo,s=this.relativeUrl+this.loadingImage,r=this.loadingVideoLoop,l=this;(this.loadingVideo||this.loadingImage)&&(t=e('<div frameborder="0" class="pr-iframe-video" ><iframe src="'+n+'"></iframe></div>').appendTo("body"),l.videoContainer=t,o=t.find("iframe")[0],i=o.contentWindow,i.onload=function(){if(l.loadingVideo){var e=i.document.querySelector("#pr-loading-video");l.video=e,e.src=a,e.autoplay=!0,e.loop=r,e.onload=function(){},e.onended=function(){t.addClass("pr-iframe-video-hidden"),console.log("视频播放完成")}}if(l.loadingImage){var o=i.document.querySelector("#pr-loading-image");l.image=o,o.src=s,o.onload=function(){var t=this.width,e=this.height;this.style.marginTop=-t/2+"px",this.style.marginLeft=-e/2+"px",this.style.display="block"}}})},i.prototype.initAudio=function(){var t,o,i,n=this.baseUrl+"audio.html",a=this;t=e('<div frameborder="0" class="pr-iframe-audio" ><iframe src="'+n+'"></iframe></div>').appendTo("body"),o=t.find("iframe")[0],i=o.contentWindow,i.onload=function(){a.audio=i.document.querySelector("#pr-audio"),a.bgAudio=i.document.querySelector("#pr-bg-audio"),a.playBgAudio()}},i.prototype.initPreloadPanoramas=function(){var t,o,i,n,a=this.baseUrl+"preload.html",s=this.baseUrl+"preload.js";return"undefined"!=typeof Worker&&(n=new Worker(s),n.onmessage=function(t){},n.onerror=function(t){throw console.log("Worker error: "+t.message+"\n"),alert("Worker error"),t},this.preloadWorker=n),t=e('<div frameborder="0" class="pr-iframe-preload" ><iframe src="'+a+'"></iframe></div>').appendTo("body"),o=t.find("iframe")[0],i=o.contentWindow,this.preloadWindow=i,new Promise(function(t,e){i.onload=function(){t()}})},i.prototype.initNavbar=function(){var t,e,o=[],i=this,n=this.navbar,a=1;t={autorotate:"autorotate",zoom:"zoom",download:"download",caption:"caption",markers:"markers",gyroscope:"gyroscope",fullscreen:"fullscreen",play:{title:"开始",className:"custom-button",content:"▶",onClick:function(){i.play(),console.log("play")},enabled:!0},pause:{title:"暂停",className:"custom-button",content:"▪",onClick:function(){i.pause(),console.log("pause")},enabled:!0},moveleft:{title:"左",className:"custom-button",content:"↶",onClick:function(){i.moveLeft(),console.log("moveLeft")},enabled:!0},moveright:{title:"右",className:"custom-button",content:"↷",onClick:function(){i.moveRight(),console.log("moveRight")},enabled:!0},moveup:{title:"上",className:"custom-button",content:"⇡",onClick:function(){i.moveUp(),console.log("moveUp")},enabled:!0},movedown:{title:"下",className:"custom-button",content:"⇣",onClick:function(){i.moveDown(),console.log("moveDown")},enabled:!0},moveforward:{title:"前进",className:"custom-button",content:"↥",onClick:function(){i.moveForward(),console.log("moveforward")},enabled:!0},moveback:{title:"后退",className:"custom-button",content:"↧",onClick:function(){i.moveBack(),console.log("moveback")},enabled:!0},moveToleft:{title:"经度-Math.PI / 3",className:"custom-button",content:"↰",onClick:function(){i.moveTo(-Math.PI/3,null),console.log("moveToleft:-Math.PI / 3")},enabled:!0},moveToright:{title:"经度Math.PI/3",className:"custom-button",content:"↱",onClick:function(){i.moveTo(Math.PI/3,null),console.log("moveToright:Math.PI / 3")},enabled:!0},moveToup:{title:"纬度Math.PI / 8",className:"custom-button",content:"⇞",onClick:function(){i.moveTo(null,Math.PI/8),console.log("moveToup:Math.PI / 8")},enabled:!0},moveTodown:{title:"纬度-Math.PI / 8",className:"custom-button",content:"⇟",onClick:function(){i.moveTo(null,-Math.PI/8),console.log("moveTodown:-Math.PI / 8")},enabled:!0},moveToCenter:{title:"纬度0,经度0",className:"custom-button",content:"⇪",onClick:function(){i.moveTo(0,0),console.log("moveToCenter:0,0")},enabled:!0},speedUp:{title:"加速",className:"custom-button",content:"↟",onClick:function(){a<1?a+=.2:++a,console.log("speed:"+a),i.setSpeed(a,"forward-back")},enabled:!0},speedDown:{title:"减速",className:"custom-button",content:"↡",onClick:function(){a<=1?a-=.2:--a,a<=.2&&(a=.2),console.log("speed:"+a),i.setSpeed(a,"forward-back")},enabled:!0}};for(var s=0,r=n.length;s<r;s++)e=n[s],o.push(t[e]);o.length>0?this.navbar=o:this.navbar=!1},i.prototype.initViewer=function(){this.viewer=new t({panorama:"",container:this.container,autoload:!1,loading_img:null,loading_txt:null,navbar:this.navbar,anim_speed:"-2rpm",default_fov:50,fisheye:!0,move_speed:1.1,time_anim:!1,gyroscope:!0,webgl:!0,transition:{duration:1e3,loader:!0,blur:!0},cache_texture:this.cache_texture,mousewheel:!1,mousemove:!1,keyboard:!1})},i.prototype.showLoading=function(){var t='<div class="paranoma-roaming-preload"> <div class="paranoma-roaming-preload-logo'+(this.loadingVideo?"-hidden":"")+'"> </div> </div>';e(t).appendTo("body")},i.prototype.closeLoading=function(){e(".paranoma-roaming-preload").remove()},i.prototype.showSubTitles=function(){var t=this.pictures.list[this.pictures.index],e=t.subTitles,o=this;e&&this.lastSubTitles.length===e.length||o.removeSubTitles(),e&&e instanceof Array&&e.forEach(function(t,e){var i,n=null;(i=o.lastSubTitles[e])&&i.url===t.url||(n=i?i.elem:null,o.showSubTitle(n,t))})},i.prototype.showSubTitle=function(t,o){t?t.attr("src",o.url).css({left:o.left,bottom:o.bottom,right:o.right,top:o.top}):(t=e('<img src="'+o.url+'"/>').css({position:"absolute",left:o.left,bottom:o.bottom,right:o.right,top:o.top}),e("#"+this.container).append(t),this.lastSubTitles.push({elem:t,url:o.url}))},i.prototype.removeSubTitles=function(){this.lastSubTitles.length>0&&(this.lastSubTitles.forEach(function(t){t.elem.remove()}),this.lastSubTitles=[])},i.prototype.getPreloadPanoramasInfo=function(){var t=this.pictures.list,e=this.cache,o=this.pictures.index,i=t.length,n=this,a=0,s=0;return e.finish?null:(e.first?(e.first=!1,a=e.current,s=e.next,e.current=e.current+e.count,e.next=e.current+e.count,s>=i&&(s=i,e.finish=!0)):o>=e.current&&o<e.next&&(a=e.next,s=e.next+e.count,e.current=e.next,e.next=e.next+e.count,s>=i&&(s=i,e.current=0,e.next=2*e.count,e.first=!0,i<3*e.count&&(e.finish=!0))),{pictures:t,relativeUrl:n.relativeUrl,start:a,end:s})},i.prototype.preloadPanoramasInIframe=function(){var t,e=["preload"],o=this.preloadWindow;return t=this.getPreloadPanoramasInfo(),t&&(e=e.concat(o.loadPictures(t.pictures,t.relativeUrl,t.start,t.end))),Promise.all(e)},i.prototype.preloadPanoramasInWebWorker=function(){var t,e=this.preloadWorker;(t=this.getPreloadPanoramasInfo())&&t.start<t.end&&e.postMessage(t)},i.prototype.playAudio=function(){var t=this.pictures.list[this.pictures.index],e=this.relativeUrl+t.audio,o=this.audio;void 0!==e&&e!==this.lastAudio&&t.audio&&(o.autoplay=!0,o.src=e,this.lastAudio=e)},i.prototype.playBgAudio=function(){var t=this.relativeUrl+this.bgAudioUrl,e=this.bgAudio;if(!this.bgAudioUrl)return void console.warn("bgAudioUrl is null!");e.paused&&void 0!==t&&(e.autoplay=!0,e.loop=!0,e.volume=this.bgAudioVolume,e.src=t,this.lastAudio=t)},i.prototype.preloadPanoramaList=function(t,e){var o,i,n=[],a=this.pictures.list,s=this.viewer;for(o=t;o<e;o++)i=a[o],n.push(s.preloadPanorama(i.url));return n},i.prototype.preloadPanoramasInTexture=function(t,e){var o,i,n=[],a=this.pictures.list,s=this.viewer,r=this.cache.texture;if(this.cache_texture.length<1)return Promise.all(["null"]);for(o=t;o<e;o++)i=a[o],n.push(s.preloadPanorama(i.url)),r.length===this.cache_texture&&r.shift(),r.push(o),console.log(r.toString());return console.log("loadall-"+this.pictures.index+":"+t+","+e),Promise.all(n)},i.prototype.preloadNextPictureTexture=function(){function t(){var r=null;o=s.getNextFrameInfo(n),e=o.pictureIndex,n=o.frameNumber,--a,-1===i.indexOf(e)&&(r=s.preloadPanoramasInTexture(e,e+1)),a>0&&(r?r.then(function(){t()}):t())}var e,o,i=this.cache.texture,n=this.frameNumber,a=this.cache_texture/4,s=this;a<1||t()},i.prototype.render=function(){var t,e,o,i=this.viewer,n=this,a=this.moveToLocation.longitude,s=this.moveToLocation.latitude;return n.preloadNextPictureTexture(),o=n.getNextPicture(),t=o.url,e=o.name,n.left?(n.longitude-=n.longitudeOffset,null!==a&&n.longitude<=a&&(n.longitude=a)):n.right&&(n.longitude+=n.longitudeOffset,null!==a&&n.longitude>=a&&(n.longitude=a)),n.up?(n.latitude+=n.latitudeOffset,null!==s&&n.latitude>=s&&(n.latitude=s)):n.down&&(n.latitude-=n.latitudeOffset,null!==s&&n.latitude<=s&&(n.latitude=s)),n.pictures.lastPicture===t?new Promise(function(t,e){i.rotate({longitude:n.longitude,latitude:n.latitude}),t()}):new Promise(function(o,a){i.setPanorama(t,{longitude:n.longitude,latitude:n.latitude},!1).then(function(){n.pictures.lastPicture=t,i.setCaption&&i.setCaption(e),o()})})},i.prototype.reanderAnimation=function(){var t,e=this;this.preloadPanoramasInWebWorker(),t=this.render(),this.playAudio(),this.showSubTitles(),"play"===this.state&&t.then(function(){requestAnimationFrame(function(){e.reanderAnimation.call(e)})})},i.prototype.play=function(){this.state!==this.stateType.play&&(this.state=this.stateType.play,this.reanderAnimation(),this.video.pause(),this.videoContainer.addClass("pr-iframe-video-hidden"))},i.prototype.pause=function(){this.state=this.stateType.pause},i.prototype.moveLeft=function(){this.left=!0,this.right=!1,this.longitudeOffset=this.longitudeOffset<=0?this.longitudeDatum:this.longitudeOffset,this.resetMoveToLocation(!0,!1)},i.prototype.moveRight=function(){this.right=!0,this.left=!1,this.longitudeOffset=this.longitudeOffset<=0?this.longitudeDatum:this.longitudeOffset,this.resetMoveToLocation(!0,!1)},i.prototype.moveUp=function(){this.up=!0,this.down=!1,this.latitudeOffset=this.latitudeOffset<=0?this.latitudeDatum:this.latitudeOffset,this.resetMoveToLocation(!1,!0)},i.prototype.moveDown=function(){this.down=!0,this.up=!1,this.latitudeOffset=this.latitudeOffset<=0?this.latitudeDatum:this.latitudeOffset,this.resetMoveToLocation(!1,!0)},i.prototype.moveForward=function(){this.forward=!0,this.back=!1,this.frameNumberOffset=this.frameNumberOffset<=0?this.frameDatum:this.frameNumberOffset},i.prototype.moveBack=function(){this.forward=!1,this.back=!0,this.frameNumberOffset=this.frameNumberOffset<=0?this.frameDatum:this.frameNumberOffset},i.prototype.moveTo=function(t,e){null!==t&&(t<this.longitude?this.moveLeft():t>this.longitude&&this.moveRight(),this.moveToLocation.longitude=t),null!==e&&(e<this.latitude?this.moveDown():e>this.latitude&&this.moveUp(),this.moveToLocation.latitude=e)},i.prototype.resetMoveToLocation=function(t,e){t?this.moveToLocation.longitude=null:e&&(this.moveToLocation.latitude=null)},i.prototype.setSpeed=function(t,e){var o=this;t=Math.abs(t),"left-right"===e?o.longitudeOffset=t*o.longitudeDatum:"up-down"===e?o.latitudeOffset=t*o.latitudeDatum:"forward-back"===e&&(o.frameNumberOffset=t*o.frameDatum)},i.prototype.getNextFrameInfo=function(t){var e=0,o=t,i=this.pictures.count;return this.forward?o+=this.frameNumberOffset:this.back&&(o-=this.frameNumberOffset),e=Math.floor(o),e>i-1?(e=0,o=e):e<0&&(e=i-1,o=e),{frameNumber:o,pictureIndex:e}},i.prototype.getNextPicture=function(){var t,e=0,o=this.frameNumber;return t=this.getNextFrameInfo(o),e=t.pictureIndex,o=t.frameNumber,this.frameNumber=o,this.pictures.index=e,this.pictures.list[e]},o.ParanomaRoaming=i}(PhotoSphereViewer,jQuery,window);